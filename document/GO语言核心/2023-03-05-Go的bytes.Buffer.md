# Go的bytes.Buffer

[toc]

## 一、bytes.Buffer 的基础知识

与`strings.Builder`一样，`bytes.Buffer`也是开箱即用的。

`bytes.Buffer`类型的用途主要是作为字节序列的缓冲区。

在内部，`bytes.Buffer`类型使用字节切片作为内容容器，并有一个int类型的字段作为已读计数，这个已读计数无法通过`bytes.Buffer`提供的方法计算出来。

```go
	var buffer1 bytes.Buffer
	contents := "Simple byte buffer for marshaling data"
  // Write contents "Simple byte buffer for marshaling data"
	fmt.Printf("Write contents %q\n", contents)
	buffer1.WriteString(contents)
  // The length of buffer: 38
	fmt.Printf("The length of buffer: %d\n", buffer1.Len())
  // The capacity of buffer: 64
	fmt.Printf("The capacity of buffer: %d\n", buffer1.Cap())
```

与`strings.Reader`类型的Len方法一样，**buffer1的Len方法返回的也是内容容器中未被读取部分的长度**，而不是其中已存内容的总长度。

> Buffer 值的长度是未读内容的长度，而不是已读内容的长度。

```go
	p1 := make([]byte, 7)
	n, _ := buffer1.Read(p1)
	// 7 bytes were read. (call Read)
	fmt.Printf("%d bytes were read. (call Read)\n", n)
	// The length of buffer: 31
	fmt.Printf("The length of buffer: %d\n", buffer1.Len())
	// The capacity of buffer: 64
	fmt.Printf("The capacity of buffer: %d\n", buffer1.Cap())
```

Buffer值的容量是它的内容容器（也就是那个字节切片）的容量，它只与当前值之上的写操作有关，并随着内容的写入而不断增长。

## 二、`bytes.Buffer`类型的值，已读计数的作用

- 读取内容时，相应方法会依据已读计数找到未读内容，并在读取之后更新计数；

  相应方法包括所有名称以Read开头的方法，以及Next方法和WriteTo方法。

- 写入内容时，如需扩容，相应方法会根据已读计数实现扩容策略；

  写入时，如果没有足够的容量，就会对容器进行扩容。

  扩容时，方法会在必要时，依据已读计数找到未读部分，并把其中的内容拷贝到扩展容器的头部位置。然后，方法会把已读计数值置为0。

  相应方法包括所有名称以Write开头的方法，以及ReadFrom方法。

- 截断内容时，相应方法截断的时已读计数代表索引之后的未读部分；

  截断方法Truncate，接受一个int类型的参数，表示在截断时需要保留头部多少个字节。

  这里的头部是未读部分的头部，而不是内容容器的头部。

  这种情况下，已读计数的值再加上参数值后得到的和，就是内容容器新的总长度。

- 读回退时，相应方法会使用已读计数记录回退点；

  用于读回退的方法有UnreadByte和UnreadRune。这两个方法分别用于回退一个字节和回退一个Unicode字符。

  **回退的前提是**，在调用它们之前的那一个操作必须是“读取”，并且是成功的读取，否则这些方法就只会忽略后续操作并返回一个非nil的错误值。

  **只有紧挨在调用`ReadRune` 方法之后，对UnreadRune方法对调用才能够成功完成。**

- 重置内容时，相应方法会把已读计数置为0；

- 导出内容时，相应方法只会导出已读计数代表的索引之后的未读部分；

  Buffer值的Bytes和String方法，只会访问未读部分的内容，并返回相应的结果值。

- 获取长度时，相应方法会依据已读计数和内容容器的长度，计算未读部分的长度并返回；

  Buffer值的Len方法返回的是内容容器未读部分的长度。

## 三、学习源码以及使用过程

学习源码以及使用的过程，按照作者写这个标准库的时候的思路：库函数 > 结构定义 > 结构函数 举例学习strings包： 

1. 先熟悉外部库函数：go doc strings|grep "^func" 
2. 熟悉对应的结构定义：go doc strings|grep "^type"|grep "struct" 
3. 接下来就应该学习对应的内部结构的函数了 go doc strings.Builder|grep "^func" 

可以使用思维导图，顺着函数的调用去看，把过程记录下来