# GO程序性能分析基础

[toc]

## 一、性能分析API和标准工具

Go程序性能分析API，主要存在于

1. runtime/pprof
2. net/http/pprof
3. runtime/trace

Go性能分析的标准工具：

- `go tool pprof`  读取性能测试的概要文件
- `go tool trace`  读取性能测试的概要文件
- `go test` 可以在程序测试完成后生成概要文件。

## 二、分析程序性能的三种概要文件

用于分析程序性能的三种概要文件：CPU 概要文件（CPU Profile）、内存概要文件（Mem Profile）和阻塞概要文件（Block Profile）。

- CPU 概要文件（CPU Profile）：上面的每一段信息，记录某次采样的那一时刻，CPU上正在执行的Go代码；
- 内存概要文件（Mem Profile）：上面的每一段信息，记录着某次采样的那一时刻，正在执行的Go代码以及堆内存的使用情况，这里包括已分配和已释放的字节数量和对象数量。
- 阻塞概要文件（Block Profile）：上面的每一段信息，记录着Go程序中的一个goroutine阻塞事件。

注意：概要文本中的信息并不是普通文本，它们都是二进制形式展示的。需要使用`go tool pprof`进行查看。

> 概要文件用常规编译器查看的话，是一堆乱码。

概要文本中的信息是通过protocol buffers 生成的二进制数据流。

### 2.2 CPU概要文件（CPU Profile）

想让程序对CPU概要信息进行采样，需要用到`runtime/pprof`包中的API：

- 调用`StartCPUProfile`函数，让程序开始对CPU概要信息进行采样；

  在`StartCPUProfile`函数执行之后，会新启动一个goroutine负责CPU概要信息的收集和输出，直到StopCPUProfile函数的调用成功。

- 调用`StopCPUProfile`函数，停止让程序对CPU概要信息进行采样；

  `StopCPUProfile`函数会调用SetCPUProfileRate函数把参数值（采样频率）设置为0。这会让CPU概要信息的采样工作停止。

  也会发“信号”给收集CPU概要信息的代码。收到信号后，把收集到所有CPU概要信息写入写入器。StopCPUProfile函数才会返回。

注意：`StartCPUProfile`函数设定的采样频率总是固定的，即：100赫兹。也就是每秒采样一百次，或者说每10毫秒采样一次。

> 赫兹（也称Hz），是CPU主频的基本单位。
>
> CPU主频，是指CPU内核工作的时钟频率，也称CPU clock speed。时钟频率的倒数就是时钟周期（clock cycle），也就是一个CPU内核执行一条运算指令所需的时间，单位是秒。
>
> 例如，主频1000Hz的CPU，它单个内核执行一条运算指令所需的时间是0.001秒，即1毫秒。
>
> 3.2GHz的多核CPU，其单个内核在1个纳秒的时间里就可以至少执行三条运算指令。

`StartCPUProfile`函数设定的CPU采样频率低的原因：

- 一方面，过高采样频率会对Go程序的运行效率造成很明显的负面影响。因此，StartCPUProfile函数会保证采样频率不超过1MHz（1兆赫，每一微妙最多采样一次）。
- 另一方面，Go语言团队发现100Hz是一个比较合适的设定。这样能得到足够多和有用的信息，也不至于让程序运行出现停滞。





